FROM oven/bun:1-alpine

WORKDIR /app

# Add build arg to bust cache
ARG CACHEBUST=1

# Copy package files
COPY package.json bun.lockb* ./

# Install dependencies
RUN bun install --frozen-lockfile

# Copy source code
COPY . .

# Build the application
RUN echo "Cache bust: $CACHEBUST" && bun run build

# Use existing user 1000 and create directories with proper permissions
RUN mkdir -p /config /tv /downloads /servarr-config /config/qBittorrent && \
    chown -R 1000:1000 /app /config /tv /downloads /servarr-config

USER 1000

EXPOSE 9000

CMD ["bun", "run", "start"]