name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  e2e:
    runs-on: arc-preparr
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.16.0

      - name: Set deployment variables
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUM="${{ github.event.pull_request.number }}"
            echo "IMAGE_TAG=pr-${PR_NUM}" >> $GITHUB_ENV
            echo "RELEASE_NAME=preparr-pr-${PR_NUM}" >> $GITHUB_ENV
            echo "NAMESPACE=preparr-pr-${PR_NUM}" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=sha-$(git rev-parse --short HEAD)" >> $GITHUB_ENV
            echo "RELEASE_NAME=preparr-e2e" >> $GITHUB_ENV
            echo "NAMESPACE=preparr-test" >> $GITHUB_ENV
          fi

      - name: Install dependencies
        run: bun install

      - name: Build PrepArr
        run: bun run build

      - name: Build and push Docker image
        run: |
          docker build -t ghcr.io/robbeverhelst/preparr:${{ env.IMAGE_TAG }} .
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker push ghcr.io/robbeverhelst/preparr:${{ env.IMAGE_TAG }}
          echo "Docker image built and pushed: ghcr.io/robbeverhelst/preparr:${{ env.IMAGE_TAG }}"

      - name: Ensure namespace exists
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} 2>/dev/null || true

      - name: Clean previous Helm release
        run: |
          helm uninstall ${{ env.RELEASE_NAME }} -n ${{ env.NAMESPACE }} --wait --no-hooks 2>/dev/null || true
          echo "Waiting for resources to be cleaned up..."
          kubectl wait --for=delete pod -l app.kubernetes.io/instance=${{ env.RELEASE_NAME }} -n ${{ env.NAMESPACE }} --timeout=60s 2>/dev/null || true

      - name: Deploy stack via Helm
        run: |
          helm upgrade --install ${{ env.RELEASE_NAME }} ./helm/preparr \
            -f helm/preparr/values-e2e.yaml \
            --set preparr.image.tag=${{ env.IMAGE_TAG }} \
            --set global.namespace=${{ env.NAMESPACE }} \
            --namespace ${{ env.NAMESPACE }} \
            --wait \
            --timeout 25m
          echo "Helm deployment completed. Current pod status:"
          kubectl get pods -n ${{ env.NAMESPACE }}

      - name: Wait for all pods ready
        run: |
          echo "Waiting for PostgreSQL..."
          kubectl wait --for=condition=ready pod -l app=postgres -n ${{ env.NAMESPACE }} --timeout=120s

          echo "Waiting for qBittorrent..."
          kubectl wait --for=condition=ready pod -l app=qbittorrent -n ${{ env.NAMESPACE }} --timeout=120s

          echo "Waiting for Prowlarr..."
          kubectl wait --for=condition=ready pod -l app=prowlarr -n ${{ env.NAMESPACE }} --timeout=180s

          echo "Waiting for Sonarr..."
          kubectl wait --for=condition=ready pod -l app=sonarr -n ${{ env.NAMESPACE }} --timeout=180s

          echo "Waiting for Radarr..."
          kubectl wait --for=condition=ready pod -l app=radarr -n ${{ env.NAMESPACE }} --timeout=180s

          echo "Waiting for Bazarr..."
          kubectl wait --for=condition=ready pod -l app=bazarr -n ${{ env.NAMESPACE }} --timeout=120s

          echo "All pods ready"

      - name: Run E2E tests
        run: bun run test:e2e
        env:
          E2E_NAMESPACE: ${{ env.NAMESPACE }}

      - name: Collect logs on failure
        if: failure()
        run: |
          mkdir -p ./e2e-logs

          echo "Collecting PrepArr sidecar logs..."
          for app in sonarr radarr prowlarr bazarr; do
            kubectl logs -n ${{ env.NAMESPACE }} -l app=$app -c preparr-init --tail=500 > ./e2e-logs/${app}-preparr-init.log 2>&1 || true
            kubectl logs -n ${{ env.NAMESPACE }} -l app=$app -c preparr-sidecar --tail=500 > ./e2e-logs/${app}-preparr-sidecar.log 2>&1 || true
            kubectl logs -n ${{ env.NAMESPACE }} -l app=$app -c $app --tail=200 > ./e2e-logs/${app}-app.log 2>&1 || true
          done

          echo "Collecting infrastructure logs..."
          kubectl logs -n ${{ env.NAMESPACE }} -l app=postgres --tail=200 > ./e2e-logs/postgres.log 2>&1 || true
          kubectl logs -n ${{ env.NAMESPACE }} -l app=qbittorrent --tail=200 > ./e2e-logs/qbittorrent.log 2>&1 || true

          echo "Collecting pod descriptions..."
          kubectl describe pods -n ${{ env.NAMESPACE }} > ./e2e-logs/pod-descriptions.txt 2>&1 || true

          echo "Collecting events..."
          kubectl get events -n ${{ env.NAMESPACE }} --sort-by='.lastTimestamp' > ./e2e-logs/events.txt 2>&1 || true

          echo "Logs collected"

      - name: Upload logs artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs
          path: ./e2e-logs/
          retention-days: 7

      - name: Cleanup Helm release
        if: always()
        run: |
          helm uninstall ${{ env.RELEASE_NAME }} -n ${{ env.NAMESPACE }} --wait --no-hooks || true
